<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cookie Scanner</title>
  <style>
    :root{
      --radius:12px; --border:#e5e7eb; --muted:#6b7280; --bg:#f6f7f9; --card:#ffffff;
    }
    *{ box-sizing:border-box; }
    body{ margin:16px; background:var(--bg); font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:#111; }
    .wrap{ max-width:980px; margin:0 auto; } /* small max width for better focus */
    h1{ margin:8px 0 6px; font-size:28px; }
    .small{ font-size:12px; }
    .muted{ color:var(--muted); }

    /* Form */
    form{ display:flex; gap:8px; flex-wrap:wrap; margin:14px 0 18px; }
    input[type="url"]{ flex:1; min-width:260px; padding:10px 12px; font-size:16px; border:1px solid var(--border); border-radius:10px; background:#fff; }
    button{ padding:10px 14px; font-size:16px; border:1px solid var(--border); background:#fff; border-radius:10px; cursor:pointer; }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    /* Always STACKED (over/under) */
    .stack{ display:flex; flex-direction:column; gap:14px; }

    /* Cards */
    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:12px; }
    .card h3{ margin:0 0 10px; display:flex; align-items:center; gap:8px; font-size:16px; }
    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); font-size:12px; color:#333; background:#fff; }

    /* Each table scrolls on its own so all three cards fit on screen */
    .table-wrap{
      max-height:32vh;          /* ~1/3 of viewport height */
      overflow:auto;
      border:1px solid var(--border);
      border-radius:8px;
      background:#fff;
    }

    table{ border-collapse:collapse; font-size:13px; width:max-content; } /* horizontal scroll when needed */
    thead th{ position:sticky; top:0; background:#fff; z-index:1; }
    th, td{
      padding:8px 10px; border-bottom:1px solid #f1f1f1; vertical-align:top;
      white-space:nowrap; /* no word breaking */
    }

    /* Column sizing */
    th[data-w="lg"], td[data-w="lg"]{ min-width:220px; }  /* name/domain */
    th[data-w="md"], td[data-w="md"]{ min-width:140px; }  /* expires/path */
    th[data-w="sm"], td[data-w="sm"]{ min-width:90px; }   /* flags */
    .url-hint{ margin:2px 0 8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Cookie Scanner</h1>
    <p class="muted small">Indtast en fuld adresse (fx <code>https://adlead.dk/</code>). App’en loader siden før samtykke og efter “Accepter”.</p>

    <form id="scan-form">
      <input id="url" type="url" placeholder="https://eksempel.dk/" required />
      <button id="goBtn" type="submit">Scan</button>
    </form>

    <div id="status" class="muted small" style="min-height:1.2em;"></div>

    <div class="stack">
      <div class="card">
        <h3>Før samtykke <span id="preCount" class="badge">0</span></h3>
        <div id="pre"></div>
      </div>
      <div class="card">
        <h3>Efter samtykke <span id="postCount" class="badge">0</span></h3>
        <div id="post"></div>
      </div>
      <div class="card">
        <h3>Tilkommet efter samtykke <span id="diffCount" class="badge">0</span></h3>
        <div id="diff"></div>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById('scan-form');
    const urlInput = document.getElementById('url');
    const goBtn = document.getElementById('goBtn');
    const statusEl = document.getElementById('status');

    const COLS = [
      { key:'name',       label:'Name',     w:'lg' },
      { key:'domain',     label:'Domain',   w:'lg' },
      { key:'firstParty', label:'1st party',w:'sm' },
      { key:'sameSite',   label:'SameSite', w:'sm' },
      { key:'secure',     label:'Secure',   w:'sm' },
      { key:'httpOnly',   label:'HttpOnly', w:'sm' },
      { key:'expires_iso',label:'Expires',  w:'md' },
      { key:'path',       label:'Path',     w:'md' }
    ];

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const url = urlInput.value.trim();
      if (!url) return;

      const oldTxt = goBtn.textContent;
      goBtn.disabled = true; goBtn.textContent = 'Scanner…';
      statusEl.textContent = 'Kører Playwright (typisk 5–15 sek.)';

      try {
        const res = await fetch('/api/scan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Ukendt fejl');

        render('pre', data.pre, 'preCount');
        render('post', data.post, 'postCount');
        render('diff', data.diff, 'diffCount');
        statusEl.textContent = 'Færdig ✔︎';
      } catch (err) {
        statusEl.textContent = 'Fejl: ' + err.message;
        render('pre', [], 'preCount');
        render('post', [], 'postCount');
        render('diff', [], 'diffCount');
      } finally {
        goBtn.disabled = false; goBtn.textContent = oldTxt;
      }
    });

    function render(id, rows, countId) {
      document.getElementById(countId).textContent = rows.length;
      const target = document.getElementById(id);
      if (!rows.length) { target.innerHTML = '<p class="muted small">Ingen data.</p>'; return; }

      const thead = `<tr>${COLS.map(c => `<th data-w="${c.w}">${c.label}</th>`).join('')}</tr>`;
      const tbody = rows.map(r => `<tr>${
        COLS.map(c => `<td data-w="${c.w}">${escapeHtml(String(r[c.key] ?? ''))}</td>`).join('')
      }</tr>`).join('');

      target.innerHTML = `
        <div class="url-hint small muted">${rows[0].url}</div>
        <div class="table-wrap">
          <table>
            <thead>${thead}</thead>
            <tbody>${tbody}</tbody>
          </table>
        </div>`;
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
  </script>
</body>
</html>
